<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Candidate-Job Matching | Personality Assessment</title>

  <style>
:root {
  --primary: 160 45% 65%;
  --primary-dark: 160 45% 55%;
  --primary-light: 160 45% 75%;
  --background: 30 20% 96%;
  --surface: 0 0% 99%;
  --surface-elevated: 30 15% 94%;
  --text-primary: 210 15% 25%;
  --text-secondary: 210 10% 45%;
  --text-tertiary: 210 8% 65%;
  --border: 30 10% 88%;
  --success: 140 40% 60%;
  --warning: 35 60% 70%;
  --danger: 0 50% 70%;
  --info: 200 45% 65%;
  --radius: 12px;
  --radius-lg: 16px;
  --spacing-sm: 12px;
  --spacing-md: 16px;
  --spacing-lg: 24px;
  --spacing-xl: 32px;
  --spacing-2xl: 48px;
}

* { box-sizing: border-box; margin: 0; padding: 0; }

body {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
  background: hsl(var(--background));
  color: hsl(var(--text-primary));
  line-height: 1.6;
  font-size: 15px;
}

.container {
  max-width: 1100px;
  margin: 0 auto;
  padding: var(--spacing-xl) var(--spacing-lg);
}

.main-header {
  text-align: center;
  margin-bottom: var(--spacing-2xl);
  padding-bottom: var(--spacing-xl);
  border-bottom: 2px solid hsl(var(--primary) / 0.2);
}

.main-header h1 {
  font-size: 40px;
  background: linear-gradient(135deg, hsl(var(--primary)), hsl(var(--primary-light)));
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
  margin-bottom: var(--spacing-sm);
  font-weight: 700;
}

.subtitle {
  font-size: 16px;
  color: hsl(var(--text-secondary));
  max-width: 600px;
  margin: 0 auto;
}

.card {
  background: hsl(var(--surface));
  border: 1px solid hsl(var(--border));
  border-radius: var(--radius-lg);
  padding: var(--spacing-xl);
  margin-bottom: var(--spacing-xl);
  transition: box-shadow 0.3s;
}

.card:hover { box-shadow: 0 2px 8px rgba(0,0,0,0.08); }

.card h3 {
  color: hsl(var(--primary));
  margin-bottom: var(--spacing-md);
  font-size: 18px;
  font-weight: 700;
}

.collapsible-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  cursor: pointer;
  padding: 6px 0;
}

.collapsible-content { display: none; }
.collapsible-open .collapsible-content { display: block; }

/* Upload Zone */
.upload-zone {
  border: 2px dashed hsl(var(--border));
  border-radius: var(--radius-lg);
  padding: var(--spacing-2xl);
  text-align: center;
  cursor: pointer;
  transition: all 0.3s;
  background: hsl(var(--surface-elevated));
  margin-top: var(--spacing-lg);
}

.upload-zone:hover {
  border-color: hsl(var(--primary));
  background: hsl(var(--primary) / 0.05);
}

.upload-zone.dragging {
  border-color: hsl(var(--primary));
  background: hsl(var(--primary) / 0.1);
  transform: scale(1.02);
}

.upload-zone.has-file {
  border-color: hsl(var(--success));
  background: hsl(var(--success) / 0.05);
}

.upload-icon {
  width: 60px;
  height: 60px;
  margin: 0 auto var(--spacing-md);
  background: hsl(var(--primary) / 0.1);
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
}

.upload-icon::before {
  content: '↑';
  font-size: 32px;
  color: hsl(var(--primary));
  font-weight: bold;
}

.file-name {
  margin-top: var(--spacing-md);
  color: hsl(var(--success));
  font-weight: 600;
}

/* Search & Selection */
.search-box {
  width: 100%;
  padding: var(--spacing-md);
  border: 2px solid hsl(var(--border));
  border-radius: var(--radius);
  font-size: 15px;
  margin-bottom: var(--spacing-lg);
  transition: border-color 0.3s;
}

.search-box:focus {
  outline: none;
  border-color: hsl(var(--primary));
  box-shadow: 0 0 0 3px hsl(var(--primary) / 0.1);
}

.selected-traits-summary {
  background: hsl(var(--primary) / 0.05);
  border: 1px solid hsl(var(--primary) / 0.2);
  border-radius: var(--radius);
  padding: var(--spacing-lg);
  margin-bottom: var(--spacing-lg);
}

.selected-traits-chips {
  display: flex;
  flex-wrap: wrap;
  gap: var(--spacing-sm);
  margin-top: var(--spacing-md);
}

.selected-trait-chip {
  display: inline-flex;
  align-items: center;
  gap: 8px;
  background: hsl(var(--surface));
  border: 1px solid hsl(var(--border));
  border-radius: 8px;
  padding: 8px 12px;
  font-size: 14px;
}

.level-indicator {
  font-size: 11px;
  font-weight: 700;
  padding: 3px 8px;
  border-radius: 4px;
  text-transform: uppercase;
}

.level-indicator.low { background: hsl(var(--warning) / 0.2); color: hsl(var(--warning)); }
.level-indicator.medium { background: hsl(var(--info) / 0.2); color: hsl(var(--info)); }
.level-indicator.high { background: hsl(var(--success) / 0.2); color: hsl(var(--success)); }

.remove-btn {
  background: none;
  border: none;
  color: hsl(var(--danger));
  cursor: pointer;
  font-size: 12px;
}

/* Trait Selector Grid */
.trait-selector-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
  gap: var(--spacing-md);
  margin-bottom: var(--spacing-xl);
}

.trait-selector-card {
  background: hsl(var(--surface));
  border: 2px solid hsl(var(--border));
  border-radius: var(--radius);
  padding: var(--spacing-lg);
  cursor: pointer;
  transition: all 0.3s;
}

.trait-selector-card:hover:not(.disabled) {
  border-color: hsl(var(--primary) / 0.5);
  transform: translateY(-2px);
  box-shadow: 0 2px 8px rgba(0,0,0,0.08);
}

.trait-selector-card.selected {
  border-color: hsl(var(--primary));
  background: hsl(var(--primary) / 0.05);
}

.trait-selector-card.disabled {
  opacity: 0.4;
  cursor: not-allowed;
}

.trait-name-selector {
  font-weight: 700;
  margin-bottom: var(--spacing-sm);
  font-size: 16px;
}

.trait-description-selector {
  font-size: 13px;
  color: hsl(var(--text-secondary));
  margin-bottom: var(--spacing-md);
  line-height: 1.6;
}

.trait-level-selector {
  display: flex;
  gap: 8px;
  margin-top: var(--spacing-md);
}

.level-btn {
  flex: 1;
  padding: 8px;
  border: 2px solid hsl(var(--border));
  background: hsl(var(--surface));
  border-radius: 8px;
  cursor: pointer;
  font-size: 13px;
  font-weight: 600;
  transition: all 0.2s;
}

.level-btn:hover { border-color: hsl(var(--primary)); }

.level-btn.active {
  background: hsl(var(--primary));
  border-color: hsl(var(--primary));
  color: white;
}

/* Buttons */
.btn {
  padding: 14px 28px;
  font-size: 15px;
  font-weight: 600;
  border: none;
  border-radius: var(--radius);
  cursor: pointer;
  transition: all 0.3s;
  font-family: inherit;
}

.btn:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}

.btn-primary {
  background: linear-gradient(135deg, hsl(var(--primary)), hsl(var(--primary-dark)));
  color: white;
  box-shadow: 0 4px 12px hsl(var(--primary) / 0.3);
}

.btn-primary:hover:not(:disabled) {
  transform: translateY(-2px);
  box-shadow: 0 6px 20px hsl(var(--primary) / 0.4);
}

/* Results */
.fit-score-banner {
  background: linear-gradient(135deg, hsl(var(--primary) / 0.1), hsl(var(--primary) / 0.05));
  border: 2px solid hsl(var(--primary));
  border-radius: var(--radius-lg);
  padding: var(--spacing-2xl);
  text-align: center;
  margin-bottom: var(--spacing-xl);
}

.fit-score-label {
  font-size: 14px;
  color: hsl(var(--text-secondary));
  text-transform: uppercase;
  letter-spacing: 1px;
  margin-bottom: var(--spacing-sm);
}

.fit-score-value {
  font-size: 48px;
  font-weight: 800;
  color: hsl(var(--primary));
  margin: var(--spacing-md) 0;
}

.recommendation-banner {
  padding: var(--spacing-lg);
  border-radius: var(--radius);
  font-weight: 600;
  font-size: 16px;
  text-align: center;
}

.recommendation-banner.strongly-recommend {
  background: hsl(var(--success) / 0.2);
  color: hsl(var(--success));
  border: 2px solid hsl(var(--success));
}

.recommendation-banner.recommend {
  background: hsl(var(--info) / 0.2);
  color: hsl(var(--info));
  border: 2px solid hsl(var(--info));
}

.recommendation-banner.caution {
  background: hsl(var(--warning) / 0.2);
  color: hsl(var(--warning));
  border: 2px solid hsl(var(--warning));
}

.recommendation-banner.not-recommend {
  background: hsl(var(--danger) / 0.2);
  color: hsl(var(--danger));
  border: 2px solid hsl(var(--danger));
}

.dimension-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
  gap: var(--spacing-md);
}

.dimension-card {
  background: hsl(var(--surface-elevated));
  border: 1px solid hsl(var(--border));
  border-radius: var(--radius);
  padding: var(--spacing-lg);
}

.dimension-score {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: var(--spacing-sm);
}

.dimension-name {
  font-weight: 700;
  font-size: 15px;
}

.score-badge {
  font-weight: 700;
  padding: 4px 10px;
  border-radius: 4px;
  font-size: 13px;
}

.score-badge.high { background: hsl(var(--success) / 0.2); color: hsl(var(--success)); }
.score-badge.medium { background: hsl(var(--info) / 0.2); color: hsl(var(--info)); }
.score-badge.low { background: hsl(var(--warning) / 0.2); color: hsl(var(--warning)); }

.likert-bar {
  height: 8px;
  background: hsl(var(--border));
  border-radius: 4px;
  overflow: hidden;
  margin: var(--spacing-sm) 0;
}

.likert-fill {
  height: 100%;
  background: linear-gradient(90deg, hsl(var(--primary)), hsl(var(--primary-light)));
  transition: width 0.5s;
}

.evidence-list {
  list-style: none;
  padding: 0;
}

.evidence-list li {
  padding: var(--spacing-md);
  background: hsl(var(--surface-elevated));
  border-left: 3px solid hsl(var(--primary));
  margin-bottom: var(--spacing-sm);
  border-radius: 8px;
}

.concern-list li { border-left-color: hsl(var(--warning)); }

/* Loading */
.loading {
  text-align: center;
  padding: var(--spacing-2xl);
}

.spinner {
  border: 4px solid hsl(var(--border));
  border-top: 4px solid hsl(var(--primary));
  border-radius: 50%;
  width: 50px;
  height: 50px;
  animation: spin 0.8s linear infinite;
  margin: 0 auto var(--spacing-lg);
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

/* Responsive */
@media (max-width: 768px) {
  .container { padding: var(--spacing-lg) var(--spacing-md); }
  .main-header h1 { font-size: 32px; }
  .trait-selector-grid, .dimension-grid { grid-template-columns: 1fr; }
}
  </style>
</head>

<body>
  <div class="container">
    <header class="main-header">
      <h1>Candidate-Job Matching</h1>
      <p class="subtitle">Upload a candidate's personality report and define the ideal trait profile for the role</p>
      <a href="/" style="color: hsl(var(--primary)); text-decoration: none;">← Back to Assessment</a>
    </header>

    <!-- Step 1: Upload Candidate Report -->
    <div id="step1" class="card collapsible-open">
      <div class="collapsible-header" id="step1Header">
        <div>Step 1: Upload Candidate's Personality Report</div>
        <div id="step1ToggleIndicator"> </div>
      </div>

      <div class="collapsible-content" id="step1Content" style="display:block;">
        <p style="color: hsl(var(--text-secondary)); margin-bottom: 20px;">
          Upload the PDF report generated from this assessment tool.
        </p>

        <div class="upload-zone" id="candidateUpload" title="Click to upload or drag & drop PDF">
          <div class="upload-icon" aria-hidden="true"></div>
          <h3>Candidate's Personality Report</h3>
          <p style="color: hsl(var(--text-secondary));">Click to upload or drag & drop</p>
          <input type="file" id="candidateFile" accept=".pdf" style="display: none;">
          <div class="file-name" id="candidateFileName"></div>
        </div>
      </div>
    </div>

    <!-- Step 2: Define Job Requirements -->
    <div id="step2" class="card" style="display:none;">
      <div class="collapsible-header" id="step2Header">
        <div>Step 2: Define Ideal Trait Profile for the Role</div>
        <div id="step2ToggleIndicator"> </div>
      </div>

      <div class="collapsible-content" id="step2Content">
        <p style="color: hsl(var(--text-secondary)); margin-bottom: 20px;">
          Select the personality traits that are most important for this role and specify the desired level (Low, Medium, or High). 
          You can select up to 15 traits. Once a trait is selected, its opposite cannot be chosen.
        </p>

        <input type="text" class="search-box" id="searchBox" placeholder="Search traits...">

        <div id="selectedTraitsSummary" class="selected-traits-summary" style="display: none;">
          <h3 style="margin-top: 0;">Selected Traits (<span id="selectedCount">0</span>/15)</h3>
          <div id="selectedTraitsChips"></div>
        </div>

        <div class="trait-selector-grid" id="traitSelectorGrid" aria-live="polite"></div>

        <button id="analyzeBtn" class="btn btn-primary" disabled style="width: 100%; margin-top: 20px;">
          Analyze Candidate Fit
        </button>
      </div>
    </div>

    <!-- Results container -->
    <div id="results" class="match-results" aria-live="polite"></div>
  </div>

  <script>
  const traitPairs = {
    'Analytical Thinking': 'Intuitive Thinking', 'Intuitive Thinking': 'Analytical Thinking',
    'Risk-Taking': 'Risk Aversion', 'Risk Aversion': 'Risk-Taking',
    'Collaboration': 'Independent Work', 'Independent Work': 'Collaboration',
    'Detail Orientation': 'Big Picture Thinking', 'Big Picture Thinking': 'Detail Orientation',
    'Adaptability': 'Consistency', 'Consistency': 'Adaptability',
    'Proactivity': 'Reactivity', 'Reactivity': 'Proactivity',
    'Empathy': 'Task Focus', 'Task Focus': 'Empathy',
    'Innovation': 'Process Adherence', 'Process Adherence': 'Innovation',
    'Decisiveness': 'Deliberation', 'Deliberation': 'Decisiveness',
    'Assertiveness': 'Diplomacy', 'Diplomacy': 'Assertiveness',
    'Optimism': 'Realism', 'Realism': 'Optimism',
    'Structured': 'Flexible', 'Flexible': 'Structured',
    'Results-Oriented': 'Process-Oriented', 'Process-Oriented': 'Results-Oriented',
    'Competitive': 'Cooperative', 'Cooperative': 'Competitive',
    'Confidence': 'Humility', 'Humility': 'Confidence'
  };

  const traitDescriptions = {
    'Analytical Thinking': 'Makes decisions based on data, logic, and systematic analysis.',
    'Intuitive Thinking': 'Relies on instinct, gut feelings, and pattern recognition.',
    'Risk-Taking': 'Comfortable with uncertainty and willing to try unconventional approaches.',
    'Risk Aversion': 'Prefers proven methods and careful planning.',
    'Collaboration': 'Thrives in team settings and values group input.',
    'Independent Work': 'Prefers autonomy and self-directed tasks.',
    'Detail Orientation': 'Focuses on precision, accuracy, and thorough execution.',
    'Big Picture Thinking': 'Focuses on strategy, vision, and overall objectives.',
    'Adaptability': 'Flexible and comfortable with change.',
    'Consistency': 'Values reliability and predictable approaches.',
    'Proactivity': 'Takes initiative and anticipates needs.',
    'Reactivity': 'Responds thoughtfully to situations as they arise.',
    'Empathy': 'Prioritizes understanding others\' feelings and perspectives.',
    'Task Focus': 'Prioritizes objectives and deliverables.',
    'Innovation': 'Seeks new solutions and creative approaches.',
    'Process Adherence': 'Follows established procedures and best practices.',
    'Decisiveness': 'Makes quick, firm decisions with available information.',
    'Deliberation': 'Takes time to consider multiple perspectives before deciding.',
    'Assertiveness': 'Direct and firm in communication.',
    'Diplomacy': 'Tactful and consensus-oriented in communication.',
    'Optimism': 'Focuses on possibilities and positive outcomes.',
    'Realism': 'Focuses on practical constraints and likely outcomes.',
    'Structured': 'Prefers organized, planned approaches.',
    'Flexible': 'Comfortable with spontaneity and fluid situations.',
    'Results-Oriented': 'Focuses on outcomes and achievement.',
    'Process-Oriented': 'Focuses on methods and quality of execution.',
    'Competitive': 'Motivated by winning and outperforming others.',
    'Cooperative': 'Motivated by mutual success and collective achievement.',
    'Confidence': 'Self-assured and willing to take charge.',
    'Humility': 'Values learning and acknowledges limitations.'
  };

  let candidateFile = null;
  let selectedJobTraits = {};
  const MAX_TRAITS = 15;

  const step1 = document.getElementById('step1');
  const step1Content = document.getElementById('step1Content');
  const step2 = document.getElementById('step2');
  const step2Content = document.getElementById('step2Content');
  const candidateUpload = document.getElementById('candidateUpload');
  const candidateInput = document.getElementById('candidateFile');
  const candidateFileName = document.getElementById('candidateFileName');
  const traitSelectorGrid = document.getElementById('traitSelectorGrid');
  const selectedTraitsSummary = document.getElementById('selectedTraitsSummary');
  const selectedTraitsChips = document.getElementById('selectedTraitsChips');
  const selectedCountSpan = document.getElementById('selectedCount');
  const searchBox = document.getElementById('searchBox');
  const analyzeBtn = document.getElementById('analyzeBtn');
  const resultsDiv = document.getElementById('results');

  function closeStep1() {
    step1Content.style.display = 'none';
    step1.classList.remove('collapsible-open');
  }

  function openStep2() {
    step2.style.display = 'block';
    step2.classList.add('collapsible-open');
    step2Content.style.display = 'block';
  }

  candidateUpload.addEventListener('click', () => candidateInput.click());

  ['dragenter','dragover','dragleave','drop'].forEach(evt => {
    candidateUpload.addEventListener(evt, e => {
      e.preventDefault();
      e.stopPropagation();
    });
  });

  candidateUpload.addEventListener('dragover', () => candidateUpload.classList.add('dragging'));
  candidateUpload.addEventListener('dragleave', () => candidateUpload.classList.remove('dragging'));
  candidateUpload.addEventListener('drop', e => {
    candidateUpload.classList.remove('dragging');
    if(e.dataTransfer.files.length) handleCandidateFile(e.dataTransfer.files[0]);
  });

  candidateInput.addEventListener('change', e => {
    if (e.target.files[0]) handleCandidateFile(e.target.files[0]);
  });

  function handleCandidateFile(file) {
    if (file.type !== 'application/pdf') {
      alert('Please upload a PDF file.');
      return;
    }
    candidateFile = file;
    candidateFileName.textContent = file.name;
    candidateUpload.classList.add('has-file');
    closeStep1();
    openStep2();
    renderTraitSelector();
    updateSelectedSummary();
    updateAnalyzeButton();
  }

  function renderTraitSelector() {
    traitSelectorGrid.innerHTML = '';
    const allTraits = Object.keys(traitDescriptions).sort();

    allTraits.forEach(traitName => {
      const isSelected = !!selectedJobTraits[traitName];
      const oppositeTraitName = traitPairs[traitName];
      const isOppositeSelected = oppositeTraitName && !!selectedJobTraits[oppositeTraitName];
      const isDisabled = isOppositeSelected && !isSelected;

      const card = document.createElement('div');
      card.className = 'trait-selector-card';
      if (isSelected) card.classList.add('selected');
      if (isDisabled) card.classList.add('disabled');

      card.innerHTML = `
        <div class="trait-name-selector">${traitName}</div>
        <div class="trait-description-selector">${traitDescriptions[traitName]}</div>
        ${!isDisabled ? `
          <div class="trait-level-selector">
            <button class="level-btn low ${isSelected && selectedJobTraits[traitName].level === 'low' ? 'active' : ''}" data-level="low">Low</button>
            <button class="level-btn medium ${isSelected && selectedJobTraits[traitName].level === 'medium' ? 'active' : ''}" data-level="medium">Medium</button>
            <button class="level-btn high ${isSelected && selectedJobTraits[traitName].level === 'high' ? 'active' : ''}" data-level="high">High</button>
          </div>
        ` : ''}
      `;

      if (!isDisabled) {
        card.querySelectorAll('.level-btn').forEach(btn => {
          btn.addEventListener('click', e => {
            e.stopPropagation();
            const level = btn.dataset.level;
            if (isSelected && selectedJobTraits[traitName].level === level) {
              delete selectedJobTraits[traitName];
            } else {
              const currentCount = Object.keys(selectedJobTraits).length;
              if (!isSelected && currentCount >= MAX_TRAITS) {
                alert('You can select up to ' + MAX_TRAITS + ' traits.');
                return;
              }
              selectedJobTraits[traitName] = { level, name: traitName, description: traitDescriptions[traitName] };
            }
            renderTraitSelector();
            updateSelectedSummary();
            updateAnalyzeButton();
          });
        });

        card.addEventListener('click', () => {
          if (!selectedJobTraits[traitName]) {
            if (Object.keys(selectedJobTraits).length >= MAX_TRAITS) {
              alert('You can select up to ' + MAX_TRAITS + ' traits.');
              return;
            }
            selectedJobTraits[traitName] = { level: 'medium', name: traitName, description: traitDescriptions[traitName] };
          } else {
            delete selectedJobTraits[traitName];
          }
          renderTraitSelector();
          updateSelectedSummary();
          updateAnalyzeButton();
        });
      }

      traitSelectorGrid.appendChild(card);
    });
  }

  function updateSelectedSummary() {
    const selectedCount = Object.keys(selectedJobTraits).length;
    selectedCountSpan.textContent = selectedCount;
    if (selectedCount === 0) {
      selectedTraitsSummary.style.display = 'none';
      return;
    }
    selectedTraitsSummary.style.display = 'block';
    selectedTraitsChips.innerHTML = '';

    Object.entries(selectedJobTraits).forEach(([traitName, data]) => {
      const chip = document.createElement('div');
      chip.className = 'selected-trait-chip';
      chip.innerHTML = `
        <span>${traitName}</span>
        <span class="level-indicator ${data.level}">${data.level.toUpperCase()}</span>
      `;
      const removeBtn = document.createElement('button');
      removeBtn.className = 'remove-btn';
      removeBtn.textContent = 'Remove';
      removeBtn.addEventListener('click', () => {
        delete selectedJobTraits[traitName];
        renderTraitSelector();
        updateSelectedSummary();
        updateAnalyzeButton();
      });
      chip.appendChild(removeBtn);
      selectedTraitsChips.appendChild(chip);
    });
  }

  function updateAnalyzeButton() {
    analyzeBtn.disabled = Object.keys(selectedJobTraits).length === 0 || !candidateFile;
  }

  searchBox.addEventListener('input', e => {
    const term = e.target.value.toLowerCase();
    document.querySelectorAll('.trait-selector-card').forEach(card => {
      const text = card.textContent.toLowerCase();
      card.style.display = text.includes(term) ? 'block' : 'none';
    });
  });

  analyzeBtn.addEventListener('click', async () => {
    resultsDiv.innerHTML = `
      <div class="loading">
        <div class="spinner"></div>
        <p>Analyzing candidate-job fit with AI...</p>
      </div>
    `;

    const formData = new FormData();
    formData.append('candidate_report', candidateFile);
    formData.append('job_requirements', JSON.stringify(selectedJobTraits));

    try {
      const resp = await fetch('/api/match-candidate', { method: 'POST', body: formData });
      if (!resp.ok) throw new Error('Analysis failed');
      const result = await resp.json();
      step2.style.display = 'none';
      displayResults(result);
    } catch (err) {
      resultsDiv.innerHTML = `
        <div class="card" style="background: hsl(var(--warning) / 0.1); border-color: hsl(var(--warning));">
          <h3 style="color: hsl(var(--warning));">Analysis Error</h3>
          <p>Sorry, there was an error analyzing the documents. Please try again.</p>
          <p style="font-size: 13px; color: hsl(var(--text-tertiary));">Error: ${err.message}</p>
        </div>
      `;
    }
  });

  function displayResults(data) {
    const fitScore = data.overall_fit_score || 3;
    const fitLabel = data.overall_fit_label || 'Adequate Fit';
    let recClass = 'recommend';
    const recText = data.hiring_recommendation || 'No recommendation available';
    if (recText.includes('Strongly Recommend')) recClass = 'strongly-recommend';
    else if (recText.includes('Do Not Recommend')) recClass = 'not-recommend';
    else if (recText.includes('with Reservations')) recClass = 'caution';

    let html = `
      <div class="fit-score-banner">
        <div class="fit-score-label">Overall Candidate Fit Score</div>
        <div class="fit-score-value">${Number(fitScore).toFixed(1)}/5.0</div>
        <div class="fit-score-label">${fitLabel}</div>
      </div>

      <div class="card">
        <h3>Hiring Recommendation</h3>
        <div class="recommendation-banner ${recClass}">${recText}</div>
      </div>

      <div class="card">
        <h3>Executive Summary</h3>
        <p style="line-height: 1.8; white-space: pre-wrap;">${data.executive_summary || 'No summary available'}</p>
      </div>

      <div class="card">
        <h3>Trait-by-Trait Fit Analysis</h3>
        <div class="dimension-grid">
    `;

    const traitScores = data.trait_scores || {};
    const allShownTraits = new Set([...Object.keys(selectedJobTraits), ...Object.keys(traitScores)]);
    
    allShownTraits.forEach(traitName => {
      const traitData = traitScores[traitName] || {};
      const score = traitData.score || 3;
      let scoreClass = 'medium';
      if (score >= 4) scoreClass = 'high';
      else if (score <= 2) scoreClass = 'low';
      const required = selectedJobTraits[traitName];

      html += `
        <div class="dimension-card">
          <div class="dimension-score">
            <span class="dimension-name">${traitName}</span>
            <span class="score-badge ${scoreClass}">${Number(score).toFixed(1)}/5</span>
          </div>
          <p style="font-size: 12px; color: hsl(var(--text-tertiary)); margin: 5px 0;">
            Required: <strong>${required ? required.level.toUpperCase() : 'N/A'}</strong>
          </p>
          <div class="likert-bar">
            <div class="likert-fill" style="width: ${(score/5)*100}%;"></div>
          </div>
          <p style="font-size: 14px; color: hsl(var(--text-secondary)); margin-top: 10px;">${traitData.analysis || ''}</p>
        </div>
      `;
    });

    html += `</div></div>`;

    html += `
      <div class="card">
        <h3>Key Strengths</h3>
        <ul class="evidence-list">
          ${(data.key_strengths || []).map(s => `<li>${s}</li>`).join('') || '<li>No strengths identified.</li>'}
        </ul>
      </div>

      <div class="card">
        <h3>Potential Concerns</h3>
        <ul class="evidence-list concern-list">
          ${(data.potential_concerns || []).map(s => `<li>${s}</li>`).join('') || '<li>No concerns identified.</li>'}
        </ul>
      </div>

      <div class="card">
        <h3>Specific Evidence from Report</h3>
        <ul class="evidence-list">
          ${(data.specific_evidence || []).map(s => `<li>${s}</li>`).join('') || '<li>No specific evidence provided.</li>'}
        </ul>
      </div>

      <div class="card">
        <h3>Risk Assessment</h3>
        <p style="line-height:1.8; white-space: pre-wrap;">${data.risk_assessment || 'No risk assessment available'}</p>
      </div>

      <div class="card">
        <h3>Development Needs</h3>
        <ul class="evidence-list">
          ${(data.development_needs || []).map(d => `<li>${d}</li>`).join('') || '<li>No development needs identified.</li>'}
        </ul>
      </div>

      <div class="card">
        <h3>Onboarding Recommendations</h3>
        <p style="margin-bottom: 15px; color: hsl(var(--text-secondary));">
          If this candidate is hired, consider these recommendations for optimal success:
        </p>
        <ul class="evidence-list">
          ${(data.onboarding_recommendations || []).map(r => `<li>${r}</li>`).join('') || '<li>No onboarding recommendations provided.</li>'}
        </ul>
      </div>
    `;

    resultsDiv.innerHTML = html;
  }

  document.querySelectorAll('.collapsible-header').forEach(header => {
    header.addEventListener('click', () => {
      const content = header.parentElement.querySelector('.collapsible-content');
      if (content) content.style.display = content.style.display === 'block' ? 'none' : 'block';
    });
  });

  renderTraitSelector();
  updateSelectedSummary();
  updateAnalyzeButton();
  </script>
</body>
</html>
